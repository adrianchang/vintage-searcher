// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String        @id @default(cuid())
  name      String        @unique
  createdAt DateTime      @default(now())
  queries   SearchQuery[]
}

model SearchQuery {
  id        String   @id @default(cuid())
  query     String
  count     Int
  enabled   Boolean  @default(true)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, query])
}

// Listings that passed the first filter (for iteration on filter rules)
model FilteredListing {
  id          String   @id @default(cuid())
  url         String   @unique
  platform    String   // ebay, shopgoodwill, etc.
  title       String
  price       Float
  imageUrls   String   // JSON array of image URLs
  description String
  rawData     String   // Full raw listing data as JSON
  createdAt   DateTime @default(now())

  // Evaluation result (null if not yet evaluated)
  evaluation  Evaluation?
}

// Full LLM evaluation results
model Evaluation {
  id             String   @id @default(cuid())
  listingId      String   @unique
  listing        FilteredListing @relation(fields: [listingId], references: [id])

  isAuthentic    Boolean
  estimatedEra   String?  // Nullable - Gemini may return null for non-vintage
  estimatedValue Float?   // Nullable - Gemini may return null for non-vintage
  currentPrice   Float
  margin         Float?   // Nullable - can't calculate if estimatedValue is null
  confidence     Float
  reasoning      String
  redFlags       String   // JSON array
  references     String   // JSON array

  isOpportunity  Boolean  // margin > threshold && confidence > threshold
  createdAt      DateTime @default(now())
}
